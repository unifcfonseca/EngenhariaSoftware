{% extends 'base.html' %}

{% block extra_head %}
<style>
    .video-container {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-width: 800px;
        margin: 30px auto;
    }

    h1 {
        color: #12205D;
    }

    video, iframe {
        width: 100%;
        border-radius: 10px;
        margin-top: 15px;
    }

    .video-wrapper {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        border-radius: 10px;
        margin-top: 15px;
    }

    .video-wrapper iframe,
    .video-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .thumbnail {
        width: 40%;
        border-radius: 10px;
        margin-top: 10px;
    }

    .reaction-buttons button {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 10px;
        transition: transform 0.2s ease;
    }

    .active {
        color: #006DAA;
        font-weight: bold;
        transform: scale(1.2);
    }

    .reaction-buttons button:hover {
        transform: scale(1.2);
    }

    .count {
        font-weight: bold;
        margin-right: 15px;
    }

    .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 6px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        border: none;
        cursor: pointer;
    }

    .btn-back {
        background-color: #e9ecef;
        color: #333;
    }

    .btn-danger {
        background-color: #f8d7da;
        color: #b02a37;
    }

    .btn-danger:hover {
        background-color: #f1b0b7;
    }
</style>
{% endblock %}

{% block content %}
<div class="video-container">
    <h1>{{ video.title }}</h1>
    <p><strong>Mat√©ria:</strong> {{ video.subject }}</p>
    {% if video.video_file %}
    <video controls>
        <source src="{{ video.video_file.url }}" type="video/mp4">
    </video>
    {% elif video.video_url %}
        <div class="video-wrapper">
        {% with video.video_url|cut:"https://www.youtube.com/watch?v="|cut:"https://youtu.be/" as yt_id %}
            <iframe
            src="https://www.youtube.com/embed/{{ yt_id }}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
            ></iframe>
        {% endwith %}
        </div>
    {% endif %}

    <p class="description">{{ video.description }}</p>

    <div class="reaction-buttons">
        <span class="count">üëç <span id="like-count">{{ video.likes }}</span></span>
        <span class="count">üëé <span id="dislike-count">{{ video.dislikes }}</span></span>

        <button id="like-btn" class="{% if user_reaction == 'like' %}active{% endif %}">üëç</button>
        <button id="dislike-btn" class="{% if user_reaction == 'dislike' %}active{% endif %}">üëé</button>

    </div>

    <div class="action-buttons">
        <a href="{% url 'home' %}" class="btn btn-back">‚¨Ö Voltar</a>

        {% if user == video.uploaded_by %}
        <button class="btn btn-danger" onclick="confirmDelete('{{ video.id }}')">
            üóëÔ∏è Excluir
        </button>
        {% endif %}
    </div>
</div>

{% if user.is_authenticated %}
<script>
function sendReaction(url) {
    fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('like-count').textContent = data.likes;
        document.getElementById('dislike-count').textContent = data.dislikes;

        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        if (url.includes('like')) {
            likeBtn.classList.toggle('active');
            dislikeBtn.classList.remove('active');
        } else {
            dislikeBtn.classList.toggle('active');
            likeBtn.classList.remove('active');
        }
    });
}

document.getElementById('like-btn').addEventListener('click', () => sendReaction("{% url 'like_video' video.id %}"));
document.getElementById('dislike-btn').addEventListener('click', () => sendReaction("{% url 'dislike_video' video.id %}"));
</script>

<script>
function getCSRFToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : "";
}

function confirmDelete(videoId) {
    if (!confirm("Tem certeza que deseja excluir esta aula?")) return;

    fetch("{% url 'delete_video' 0 %}".replace("0", videoId), {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
        },
    })
    .then(res => {
        if (!res.ok) throw new Error("Erro na requisi√ß√£o");
        return res.json();
    })
    .then(data => {
        alert(data.message);
        if (data.success) {
            window.location.href = "{% url 'my_videos' %}";
        }
    })
    .catch(err => {
        console.error(err);
        alert("Ocorreu um erro ao tentar excluir o v√≠deo.");
    });
}
</script>
{% endif %}
{% endblock %}
